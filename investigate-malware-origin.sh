#!/bin/bash
# Investigate how malware got on the system and what brought it back

HOST="92.205.231.55"
USER="nomadadmin"

echo "üîç Investigating Malware Origin and Entry Points"
echo "================================================"
echo ""

ssh $USER@$HOST << 'ENDSSH'
cd /var/www/nomad-stop

echo "1. Checking if javs malware is back..."
ps aux | grep javs | grep -v grep || echo "‚úÖ No javs processes currently running"
ls -la /home/nomadadmin/.javs 2>/dev/null || echo "‚úÖ .javs directory not found"

echo ""
echo "2. Checking SSH access logs (recent logins)..."
echo "Last 20 SSH logins:"
sudo last -20 | head -20 || echo "Could not access login logs"

echo ""
echo "3. Checking for suspicious SSH keys..."
echo "Authorized keys:"
cat ~/.ssh/authorized_keys 2>/dev/null | wc -l
echo "keys found"
if [ -f ~/.ssh/authorized_keys ]; then
    echo "Key details:"
    cat ~/.ssh/authorized_keys
fi

echo ""
echo "4. Checking for suspicious scripts in home directory..."
find ~ -maxdepth 2 -type f -name "*.sh" -o -name "*.py" -o -name "*.js" 2>/dev/null | head -10

echo ""
echo "5. Checking systemd services for suspicious entries..."
systemctl list-units --type=service --all | grep -E "(javs|miner|stratum|xmrig)" || echo "No suspicious services found"

echo ""
echo "6. Checking for suspicious cron jobs (all users)..."
sudo crontab -l 2>/dev/null | head -20 || echo "No root crontab"
crontab -l 2>/dev/null | head -20 || echo "No user crontab"

echo ""
echo "7. Checking for suspicious processes currently running..."
ps aux | grep -E "(miner|java|javs|xmrig|stratum|gaganode)" | grep -v grep || echo "No suspicious processes"

echo ""
echo "8. Checking when .bashrc was last modified..."
if [ -f ~/.bashrc ]; then
    ls -la ~/.bashrc
    echo ""
    echo "Recent changes to .bashrc (last 10 lines with javs context):"
    grep -B5 -A5 "javs" ~/.bashrc.backup 2>/dev/null | head -20 || echo "Backup file not found or no javs references"
fi

echo ""
echo "9. Checking for suspicious network connections..."
sudo netstat -tulnp 2>/dev/null | grep -E "(ESTABLISHED|LISTEN)" | grep -v "127.0.0.1" | head -10 || echo "Could not check network connections"

echo ""
echo "10. Checking for suspicious files in /tmp and /var/tmp..."
ls -la /tmp/*javs* /var/tmp/*javs* 2>/dev/null | head -10 || echo "No javs files in temp directories"

echo ""
echo "11. Checking for wget/curl downloads in history..."
history | grep -E "(wget|curl)" | grep -E "(javs|\.sh|\.py)" | tail -10 || echo "No suspicious downloads in history"

echo ""
echo "12. Checking for other suspicious directories..."
find /home -name "*javs*" -o -name "*miner*" -o -name "*xmrig*" 2>/dev/null | head -10

echo ""
echo "13. Checking system logs for suspicious activity..."
sudo journalctl -u ssh --since "7 days ago" | grep -E "(Accepted|Failed)" | tail -20 || echo "Could not access SSH logs"

echo ""
echo "14. Checking for suspicious npm/node packages..."
if [ -f /var/www/nomad-stop/package.json ]; then
    echo "Checking package.json for suspicious dependencies..."
    grep -E "(javs|miner|xmrig|stratum)" /var/www/nomad-stop/package.json || echo "No suspicious packages in package.json"
fi

echo ""
echo "15. Checking for suspicious environment variables..."
env | grep -E "(JAVS|MINER|XMRIG)" || echo "No suspicious environment variables"

echo ""
echo "16. Checking for other user accounts..."
cat /etc/passwd | grep -E "(bash|sh)" | grep -v "nologin" | head -10

echo ""
echo "17. Checking disk usage for suspicious large files..."
find /home/nomadadmin -type f -size +10M 2>/dev/null | head -10

echo ""
echo "18. Checking for suspicious systemd timers..."
systemctl list-timers --all | head -10

echo ""
echo "‚úÖ Investigation complete!"
ENDSSH

