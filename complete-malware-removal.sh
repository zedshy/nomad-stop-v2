#!/bin/bash
# Complete malware removal - removes files and all persistence mechanisms

HOST="92.205.231.55"
USER="nomadadmin"

echo "üîí Complete Malware Removal"
echo "============================"
echo ""

ssh $USER@$HOST << 'ENDSSH'
cd /var/www/nomad-stop

echo "1. Killing any running javs processes..."
pkill -9 javs 2>/dev/null || echo "No javs processes running"
sleep 2

echo ""
echo "2. Removing malware directory..."
if [ -d "/home/nomadadmin/.javs" ]; then
    rm -rf /home/nomadadmin/.javs
    echo "‚úÖ Removed /home/nomadadmin/.javs"
else
    echo "Directory already removed"
fi

echo ""
echo "3. Removing auto-start from .bashrc..."
if grep -q "javs" ~/.bashrc; then
    # Create backup
    cp ~/.bashrc ~/.bashrc.backup.$(date +%Y%m%d_%H%M%S)
    # Remove javs lines
    sed -i '/javsËá™ÂêØÂä®/,/nohup.*javs.*daemonized/d' ~/.bashrc
    echo "‚úÖ Removed javs auto-start from .bashrc"
    echo "   Backup saved to ~/.bashrc.backup.*"
else
    echo ".bashrc already clean"
fi

echo ""
echo "4. Removing crontab entry..."
crontab -l 2>/dev/null | grep -v "javs" | crontab -
if [ $? -eq 0 ]; then
    echo "‚úÖ Removed javs from crontab"
else
    echo "Crontab already clean or empty"
fi

echo ""
echo "5. Verifying removal..."
echo "Checking .bashrc:"
grep -n "javs" ~/.bashrc 2>/dev/null || echo "‚úÖ No javs found in .bashrc"
echo ""
echo "Checking crontab:"
crontab -l 2>/dev/null | grep "javs" || echo "‚úÖ No javs found in crontab"
echo ""
echo "Checking for javs processes:"
ps aux | grep javs | grep -v grep || echo "‚úÖ No javs processes running"
echo ""
echo "Checking for javs directory:"
ls -la /home/nomadadmin/.javs 2>/dev/null || echo "‚úÖ .javs directory removed"

echo ""
echo "6. Restarting systemd-resolved to reduce CPU usage..."
sudo systemctl restart systemd-resolved
sleep 2

echo ""
echo "7. Current CPU usage:"
top -bn1 | head -5

echo ""
echo "8. Website status:"
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 --max-time 5 || echo "000")
if [ "$HTTP_CODE" = "200" ]; then
    echo "‚úÖ Website is responding (HTTP $HTTP_CODE)"
else
    echo "‚ùå Website not responding (HTTP $HTTP_CODE)"
fi

echo ""
echo "9. PM2 status:"
pm2 status

echo ""
echo "‚úÖ Malware removal complete!"
echo ""
echo "The malware should not restart automatically anymore."
echo "Monitor with: ps aux | grep javs"
ENDSSH

