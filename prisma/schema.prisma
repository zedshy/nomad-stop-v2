generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id          String           @id @default(uuid())
  name        String
  slug        String           @unique
  description String?
  category    String
  popular     Boolean          @default(false)
  sortOrder   Int              @default(0)
  imageUrl    String?
  createdAt   DateTime         @default(now())
  allergens   String
  addons      Addon[]
  variants    ProductVariant[]

  @@map("products")
}

model ProductVariant {
  id        String  @id @default(uuid())
  productId String
  name      String
  price     Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_variants")
}

model Addon {
  id        String   @id @default(uuid())
  productId String?
  name      String
  price     Int
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("addons")
}

model Order {
  id            String         @id @default(uuid())
  createdAt     DateTime       @default(now())
  status        OrderStatus
  fulfilment    FulfilmentType
  slotStart     DateTime?
  slotEnd       DateTime?
  customerName  String
  customerPhone String
  customerEmail String?
  addressLine1  String?
  city          String?
  postcode      String?
  notes         String?
  subtotal      Int
  deliveryFee   Int
  tip           Int
  serviceFee    Int
  total         Int
  currency      String         @default("GBP")
  items         OrderItem[]
  payment       Payment?

  @@map("orders")
}

model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  sku       String
  name      String
  price     Int
  quantity  Int
  addons    Json?
  allergens String
  order     Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model Payment {
  id          String        @id @default(uuid())
  orderId     String        @unique
  gateway     String        @default("worldpay")
  status      PaymentStatus
  worldpayRef String?
  amount      Int
  currency    String        @default("GBP")
  createdAt   DateTime      @default(now())
  capturedAt  DateTime?
  order       Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model PromoCode {
  id             String       @id @default(uuid())
  code           String       @unique
  name           String
  description    String?
  discountType   DiscountType @map("discountType")
  discountValue  Int          @map("discountValue")
  minOrderAmount Int          @default(0) @map("minOrderAmount")
  maxDiscount    Int?         @map("maxDiscount")
  startDate      DateTime     @default(now()) @map("startDate")
  endDate        DateTime     @map("endDate")
  usageLimit     Int?         @map("usageLimit")
  usedCount      Int          @default(0) @map("usedCount")
  isActive       Boolean      @default(true) @map("isActive")
  createdAt      DateTime     @default(now()) @map("createdAt")

  @@map("promotions")
}

enum OrderStatus {
  payment_authorized
  captured
  rejected
  preparing
  ready
  completed
}

enum FulfilmentType {
  pickup
  delivery
}

enum PaymentStatus {
  authorized
  captured
  voided
  failed
}

enum DiscountType {
  percentage
  fixed
}

enum AdminRole {
  super_admin
  admin
  staff
}

model Admin {
  id          String    @id @default(uuid())
  email       String    @unique
  username    String?   @unique
  passwordHash String   @map("password_hash")
  name        String?
  role        AdminRole @default(admin)
  isActive    Boolean   @default(true) @map("is_active")
  lastLogin   DateTime? @map("last_login")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("admins")
}
