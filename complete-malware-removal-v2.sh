#!/bin/bash

echo "=== Complete Malware Removal and Prevention ==="
echo ""

echo "1. Killing all malware processes..."
pkill -9 -f javs 2>/dev/null || true
pkill -9 -f .javs 2>/dev/null || true
pkill -9 -f nezha 2>/dev/null || true
pkill -9 -f gaganode 2>/dev/null || true
pkill -9 -f "java.*javs" 2>/dev/null || true
sleep 2

echo "2. Removing malware directories..."
rm -rf /home/nomadadmin/.javs 2>/dev/null || true
rm -rf /home/nomadadmin/.nezha 2>/dev/null || true
rm -rf /home/nomadadmin/.gaganode 2>/dev/null || true
rm -rf /tmp/javs 2>/dev/null || true
rm -rf /tmp/.javs 2>/dev/null || true

echo "3. Checking and cleaning .bashrc..."
if [ -f ~/.bashrc ]; then
    # Remove javs, nezha, gaganode entries
    sed -i '/javs/d' ~/.bashrc 2>/dev/null || true
    sed -i '/nezha/d' ~/.bashrc 2>/dev/null || true
    sed -i '/gaganode/d' ~/.bashrc 2>/dev/null || true
    sed -i '/\.javs/d' ~/.bashrc 2>/dev/null || true
    sed -i '/nohup.*javs/d' ~/.bashrc 2>/dev/null || true
    echo "   ✓ Cleaned .bashrc"
fi

echo "4. Checking and cleaning .bash_profile..."
if [ -f ~/.bash_profile ]; then
    sed -i '/javs/d' ~/.bash_profile 2>/dev/null || true
    sed -i '/nezha/d' ~/.bash_profile 2>/dev/null || true
    sed -i '/gaganode/d' ~/.bash_profile 2>/dev/null || true
    echo "   ✓ Cleaned .bash_profile"
fi

echo "5. Checking and cleaning crontab..."
crontab -l 2>/dev/null | grep -v javs | grep -v nezha | grep -v gaganode | crontab - 2>/dev/null || true
echo "   ✓ Cleaned crontab"

echo "6. Checking systemd services..."
systemctl list-units --type=service --all | grep -i javs && systemctl disable javs 2>/dev/null || true
systemctl list-units --type=service --all | grep -i nezha && systemctl disable nezha 2>/dev/null || true
systemctl list-units --type=service --all | grep -i gaganode && systemctl disable gaganode 2>/dev/null || true

echo "7. Checking for suspicious processes..."
echo "   Current processes:"
ps aux | grep -E "javs|nezha|gaganode" | grep -v grep || echo "   ✓ No malware processes found"

echo "8. Checking for malware files..."
find /home/nomadadmin -name "*javs*" -o -name "*nezha*" -o -name "*gaganode*" 2>/dev/null | head -10 || echo "   ✓ No malware files found"

echo "9. Checking network connections..."
netstat -tuln | grep -E "javs|nezha|gaganode" || echo "   ✓ No suspicious network connections"

echo "10. Securing .bashrc - making it read-only (except for root)..."
chmod 644 ~/.bashrc 2>/dev/null || true

echo ""
echo "=== Verification ==="
echo "Checking if malware is still present..."

if [ -d "/home/nomadadmin/.javs" ]; then
    echo "   ❌ WARNING: .javs directory still exists!"
else
    echo "   ✓ .javs directory removed"
fi

if ps aux | grep -q "[j]avs"; then
    echo "   ❌ WARNING: javs process still running!"
else
    echo "   ✓ No javs processes running"
fi

if crontab -l 2>/dev/null | grep -q "javs\|nezha\|gaganode"; then
    echo "   ❌ WARNING: Malware entries still in crontab!"
    crontab -l | grep -E "javs|nezha|gaganode"
else
    echo "   ✓ Crontab clean"
fi

if grep -q "javs\|nezha\|gaganode" ~/.bashrc 2>/dev/null; then
    echo "   ❌ WARNING: Malware entries still in .bashrc!"
    grep -E "javs|nezha|gaganode" ~/.bashrc
else
    echo "   ✓ .bashrc clean"
fi

echo ""
echo "=== Prevention ==="
echo "To prevent reinfection:"
echo "1. Ensure SSH password authentication is disabled"
echo "2. Use only SSH keys for access"
echo "3. Keep system updated: sudo apt update && sudo apt upgrade"
echo "4. Monitor processes regularly: ps aux | grep -E 'javs|nezha|gaganode'"
echo ""
echo "=== Removal Complete ==="

