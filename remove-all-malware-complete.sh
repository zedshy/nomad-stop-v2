#!/bin/bash
# Complete malware removal - javs + nezha/gaganode

HOST="92.205.231.55"
USER="nomadadmin"

echo "ðŸ§¹ Complete Malware Removal"
echo "==========================="
echo ""

ssh $USER@$HOST << 'ENDSSH'
cd ~

echo "=== STEP 1: Remove Nezha/Gaganode Malware ==="
echo ""

# Kill nezha processes
echo "Killing nezha processes..."
sudo pkill -9 nezha-agent 2>/dev/null
sudo pkill -9 apphub 2>/dev/null
sudo pkill -9 gaganode 2>/dev/null
sleep 2

# Check if still running
ps aux | grep -E "(nezha|gaganode)" | grep -v grep || echo "âœ… No nezha processes"

# Remove nezha directory
if [ -d "/opt/nezha" ]; then
    echo ""
    echo "Removing /opt/nezha directory..."
    sudo rm -rf /opt/nezha
    echo "âœ… Removed"
else
    echo "âœ… /opt/nezha already removed"
fi

# Check for nezha systemd services
echo ""
echo "Checking for nezha systemd services..."
systemctl list-units --all | grep nezha || echo "âœ… No nezha services"

# Disable and stop any nezha services
sudo systemctl disable nezha-agent 2>/dev/null
sudo systemctl stop nezha-agent 2>/dev/null

echo ""
echo "=== STEP 2: Remove Javs Malware (if still present) ==="
echo ""

# Kill javs
pkill -9 javs 2>/dev/null
rm -rf /home/nomadadmin/.javs 2>/dev/null

# Check
ps aux | grep javs | grep -v grep || echo "âœ… No javs processes"
ls -la /home/nomadadmin/.javs 2>/dev/null || echo "âœ… No javs directory"

echo ""
echo "=== STEP 3: Fix .bashrc ==="
echo ""

# Fix .bashrc syntax error
if [ -f ~/.bashrc.backup ]; then
    echo "Restoring .bashrc from backup..."
    cp ~/.bashrc.backup ~/.bashrc
    # Remove javs malware section
    sed -i '/# javsè‡ªå¯åŠ¨/,/nohup.*javs.*daemonized/d' ~/.bashrc
    # Remove orphaned if/fi
    sed -i '/^[[:space:]]*if[[:space:]]*$/d' ~/.bashrc
    sed -i '/^[[:space:]]*fi[[:space:]]*$/d' ~/.bashrc
    echo "âœ… .bashrc restored and cleaned"
else
    echo "No backup found, checking for syntax errors..."
    # Try to fix manually
    sed -i '115,125d' ~/.bashrc 2>/dev/null
fi

# Test syntax
if bash -n ~/.bashrc 2>/dev/null; then
    echo "âœ… .bashrc syntax is valid"
else
    echo "âš ï¸  .bashrc still has syntax errors - may need manual fix"
fi

echo ""
echo "=== STEP 4: Clean Crontab ==="
echo ""

# Remove javs from crontab
crontab -l 2>/dev/null | grep -v "javs" | crontab - 2>/dev/null
echo "âœ… Crontab cleaned"

echo ""
echo "=== STEP 5: Block Attacker IPs ==="
echo ""

# Block known attacker IPs
echo "Blocking attacker IPs..."
sudo ufw deny from 92.40.170.154 2>/dev/null
sudo ufw deny from 92.40.170.155 2>/dev/null
sudo ufw deny from 92.40.170.156 2>/dev/null
sudo ufw deny from 192.227.134.84 2>/dev/null
sudo ufw deny from 206.237.7.21 2>/dev/null
sudo ufw deny from 142.93.234.218 2>/dev/null
sudo ufw deny from 45.140.17.124 2>/dev/null
sudo ufw deny from 164.92.147.69 2>/dev/null
sudo ufw deny from 80.94.93.233 2>/dev/null
echo "âœ… Attacker IPs blocked"

echo ""
echo "=== STEP 6: Final Verification ==="
echo ""

echo "Checking for malware processes:"
ps aux | grep -E "(javs|nezha|gaganode|miner|xmrig)" | grep -v grep || echo "âœ… No malware processes"

echo ""
echo "Checking for malware directories:"
ls -la /home/nomadadmin/.javs 2>/dev/null || echo "âœ… No javs directory"
ls -la /opt/nezha 2>/dev/null || echo "âœ… No nezha directory"

echo ""
echo "Checking .bashrc:"
grep -E "(javs|nezha|gaganode)" ~/.bashrc 2>/dev/null || echo "âœ… No malware in .bashrc"

echo ""
echo "Checking crontab:"
crontab -l 2>/dev/null | grep -E "(javs|nezha|gaganode)" || echo "âœ… No malware in crontab"

echo ""
echo "=== âœ… MALWARE REMOVAL COMPLETE ==="
echo ""
echo "Next steps:"
echo "1. Secure SSH (disable password auth, use keys)"
echo "2. Install fail2ban"
echo "3. Change all passwords"
echo "4. Monitor daily for return"
ENDSSH

