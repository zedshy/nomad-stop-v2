#!/bin/bash
# Remove javs malware and secure the server

HOST="92.205.231.55"
USER="nomadadmin"

echo "üîí Removing Malware and Securing Server"
echo "======================================="
echo ""

ssh $USER@$HOST << 'ENDSSH'
cd /var/www/nomad-stop

echo "1. Killing any running javs processes..."
pkill -9 javs 2>/dev/null || echo "No javs processes running"
sleep 2

echo ""
echo "2. Removing javs malware directory..."
if [ -d "/home/nomadadmin/.javs" ]; then
    rm -rf /home/nomadadmin/.javs
    echo "‚úÖ Removed /home/nomadadmin/.javs"
else
    echo "Directory already removed"
fi

echo ""
echo "3. Checking for auto-start scripts..."
echo "Checking .bashrc..."
grep -n "javs" ~/.bashrc 2>/dev/null || echo "Not in .bashrc"
echo "Checking .bash_profile..."
grep -n "javs" ~/.bash_profile 2>/dev/null || echo "Not in .bash_profile"
echo "Checking crontab..."
crontab -l 2>/dev/null | grep -n "javs" || echo "Not in crontab"

echo ""
echo "4. Checking systemd services..."
systemctl list-units --type=service | grep -i javs || echo "No javs systemd services"

echo ""
echo "5. Checking for other suspicious processes..."
ps aux | grep -E "(miner|java|javs|xmrig|stratum)" | grep -v grep || echo "No other suspicious processes"

echo ""
echo "6. Current CPU usage:"
top -bn1 | head -5

echo ""
echo "7. Website status:"
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 --max-time 5 || echo "000")
if [ "$HTTP_CODE" = "200" ]; then
    echo "‚úÖ Website is responding (HTTP $HTTP_CODE)"
else
    echo "‚ùå Website not responding (HTTP $HTTP_CODE)"
fi

echo ""
echo "8. PM2 status:"
pm2 status

echo ""
echo "‚úÖ Malware removal complete!"
echo ""
echo "Monitor CPU with: top"
echo "Check if javs comes back: ps aux | grep javs"
ENDSSH

