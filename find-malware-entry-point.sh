#!/bin/bash
# Find how malware got on the system - focused investigation

HOST="92.205.231.55"
USER="nomadadmin"

echo "üîç Finding Malware Entry Point"
echo "==============================="
echo ""

ssh $USER@$HOST << 'ENDSSH'
cd /var/www/nomad-stop

echo "=== CRITICAL: How Malware Got In ==="
echo ""

echo "1. SSH Access History (who logged in recently):"
echo "Last 50 logins:"
sudo last -50 2>/dev/null | head -50 || last -50 | head -50

echo ""
echo "2. Failed SSH Login Attempts (brute force attacks):"
sudo grep "Failed password" /var/log/auth.log 2>/dev/null | tail -30 || \
sudo grep "Failed password" /var/log/secure 2>/dev/null | tail -30 || \
echo "Could not access auth logs"

echo ""
echo "3. Suspicious IPs that logged in:"
sudo last -50 2>/dev/null | awk '{print $3}' | sort | uniq -c | sort -rn | head -10

echo ""
echo "4. When was .bashrc modified (malware installation time)?"
if [ -f ~/.bashrc.backup ]; then
    echo "Backup file timestamps:"
    ls -la ~/.bashrc.backup
    echo ""
    echo "Current .bashrc timestamps:"
    ls -la ~/.bashrc
    echo ""
    echo "Difference (when malware was added):"
    stat -c "%y" ~/.bashrc.backup 2>/dev/null || stat -f "%Sm" ~/.bashrc.backup 2>/dev/null
fi

echo ""
echo "5. Checking for gaganode/nezha (saw this in processes earlier):"
ps aux | grep -E "(gaganode|nezha)" | grep -v grep
if [ -d "/opt/nezha" ]; then
    echo "‚ö†Ô∏è  /opt/nezha directory exists!"
    ls -la /opt/nezha/ 2>/dev/null | head -20
    echo ""
    echo "When was it installed?"
    stat -c "%y" /opt/nezha 2>/dev/null || stat -f "%Sm" /opt/nezha 2>/dev/null
fi

echo ""
echo "6. Checking bash history for installation commands:"
echo "Recent commands (last 100):"
history | tail -100 | grep -E "(wget|curl|bash|sh|\.sh|http|https|javs|miner)" || echo "No suspicious commands in recent history"

echo ""
echo "7. Checking for downloaded scripts in common locations:"
find /tmp /var/tmp ~ -maxdepth 2 -name "*.sh" -mtime -30 2>/dev/null | head -10

echo ""
echo "8. Checking systemd for suspicious services:"
systemctl list-units --type=service --all | grep -E "(nezha|gaganode|javs)" || echo "No suspicious services"

echo ""
echo "9. Checking for suspicious cron jobs:"
echo "User crontab:"
crontab -l 2>/dev/null
echo ""
echo "System cron:"
ls -la /etc/cron.d/ /etc/cron.daily/ /etc/cron.hourly/ 2>/dev/null | grep -E "(nezha|gaganode|javs)" || echo "No suspicious cron files"

echo ""
echo "10. Checking authorized SSH keys (backdoor check):"
if [ -f ~/.ssh/authorized_keys ]; then
    echo "SSH keys:"
    cat ~/.ssh/authorized_keys
    echo ""
    echo "When were keys added?"
    stat -c "%y" ~/.ssh/authorized_keys 2>/dev/null || stat -f "%Sm" ~/.ssh/authorized_keys 2>/dev/null
fi

echo ""
echo "11. Checking for other user accounts (backdoor users):"
cat /etc/passwd | grep -E "/(bash|sh)$" | grep -v "nologin"

echo ""
echo "12. Network connections to suspicious IPs:"
sudo netstat -tulnp 2>/dev/null | grep -v "127.0.0.1" | grep ESTAB | head -20 || \
sudo ss -tulnp 2>/dev/null | grep -v "127.0.0.1" | grep ESTAB | head -20 || \
echo "Could not check connections"

echo ""
echo "13. Checking package.json postinstall scripts (could be attack vector):"
if [ -f /var/www/nomad-stop/package.json ]; then
    echo "Postinstall script:"
    grep -A 5 '"postinstall"' /var/www/nomad-stop/package.json || echo "No postinstall script"
fi

echo ""
echo "14. Checking for environment variable injection:"
env | grep -E "(JAVS|MINER|XMRIG|NODE|NPM)" | head -10

echo ""
echo "15. Checking when javs directory was created (if it exists):"
if [ -d "/home/nomadadmin/.javs" ]; then
    echo "‚ö†Ô∏è  .javs directory still exists!"
    ls -la /home/nomadadmin/.javs
    stat -c "%y" /home/nomadadmin/.javs 2>/dev/null || stat -f "%Sm" /home/nomadadmin/.javs 2>/dev/null
else
    echo "‚úÖ .javs directory removed"
fi

echo ""
echo "=== MOST LIKELY ENTRY POINTS ==="
echo ""
echo "Based on investigation, malware likely entered via:"
echo "1. Weak SSH password (brute force attack)"
echo "2. Exposed SSH port with password authentication"
echo "3. Compromised npm package or postinstall script"
echo "4. Another compromised service (gaganode/nezha)"
echo ""
echo "Check the SSH login history above to see when unauthorized access occurred."
ENDSSH

